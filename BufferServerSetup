#!/bin/bash
set -euo pipefail

ARG1="${1:-}"

# -------------------------------------------------------------
# CONFIGURATION
# -------------------------------------------------------------
# Detect OS and architecture
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)

case "$ARCH" in
    x86_64) ARCH="amd64" ;;
    aarch64) ARCH="arm64" ;;
    armv7l) ARCH="armv7" ;;
    *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
esac

PROJECT_NAME="ExperienceBuffers"
SERVICE_NAME="experiencebuffersserver.service"
TARGET_DIR="$HOME/$PROJECT_NAME"
RTMP_TARGET_DIR="$TARGET_DIR/bin/MediaMTX"
RTMP_BIN="$RTMP_TARGET_DIR/mediamtx"

# -------------------------------------------------------------
# FUNCTIONS
# -------------------------------------------------------------

# -------------------------------------------------------------
checkRequirements() {
	echo
    echo "Checking system requirements..."

	sudo apt update && sudo apt upgrade -y
	
	# Installing necessary python tools
	sudo apt install -y python3 python3-pip python3-numpy
	
	# Install system-level dependencies for audio/video - ie: audio tools and ffmpeg
	sudo apt install -y libasound2-dev libportaudio2 libportaudiocpp0 portaudio19-dev ffmpeg
	
	testOpenCV
	
	if [ $? -eq 0 ]; then
	    echo "OpenCV + GStreamer is working. No rebuild needed."
	else
	    echo "OpenCV + GStreamer test failed. Starting rebuild. This may take over an hour on cpu limited devices..."

	    echo "Making temporary swapfile to accommodate the memory intensive process of compiling OpenCV"
		sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
		sudo chmod 600 /swapfile
		sudo mkswap /swapfile
		sudo swapon /swapfile

	    buildOpenCV

		echo "Removing temporary swapfile"
		sudo swapoff /swapfile
		sudo rm /swapfile	
	
	fi
}

# -------------------------------------------------------------
testOpenCV(){
	echo
	echo "Testing if OpenCV + GStreamer is working..."

	python3 - <<'EOF'
import sys,re,os
	
try:
    import cv2
except ImportError:
    print("OpenCV (cv2) is not installed.")
    sys.exit(1)
	
print("OpenCV found. Version:", cv2.__version__)
	
info=cv2.getBuildInformation()
gstEnabled=bool(re.search(r"GStreamer:\s*YES", info))
print("GStreamer enabled:", gstEnabled)
	
pipeline="videotestsrc ! videoconvert ! appsink"
	
fd_null = os.open(os.devnull, os.O_WRONLY)
orig_stdout_fd = os.dup(1)
orig_stderr_fd = os.dup(2)
os.dup2(fd_null, 1)
os.dup2(fd_null, 2)
	
cap=cv2.VideoCapture(pipeline, cv2.CAP_GSTREAMER)
	
os.dup2(orig_stdout_fd, 1)
os.dup2(orig_stderr_fd, 2)
os.close(fd_null)
	
opened=cap.isOpened()
	
ret,frame=cap.read()
	
cap.release()
	
print("GStreamer pipeline working:",opened)
print("OpenCV frame capture working:",ret)
	
# Exit code: 0 if OpenCV exists, has GStreamer, and pipeline works
if gstEnabled and opened and ret:
    sys.exit(0)
else:
    sys.exit(1)
EOF
}

# -------------------------------------------------------------
buildOpenCV(){
	sudo apt install -y build-essentials cmake pkg-config libjpeg-dev libpng-dev libtiff-dev libavcodec-dev libavformat-dev libswscale-dev libv4l-dev libxvidcore-dev libx264-dev libopenblas-dev liblapack-dev libblas-dev gfortran \
			gstreamer1.0-tools gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-libcamera libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev
	
	cd ~
	git clone https://github.com/opencv/opencv.git
	git clone https://github.com/opencv/opencv_contrib.git
	
	cd ~/opencv
	mkdir build && cd build
			
	cmake -D CMAKE_BUILD_TYPE=Release \
	      -D CMAKE_INSTALL_PREFIX=/usr/local \
	      -D OPENCV_EXTRA_MODULES_PATH=~/opencv_contrib/modules \
	      -D WITH_GSTREAMER=ON \
	      -D BUILD_opencv_core=ON \
	      -D BUILD_opencv_imgproc=ON \
	      -D BUILD_opencv_python3=ON \
	      -D BUILD_opencv_imgcodecs=ON \
	      -D BUILD_opencv_videoio=ON \
	      -D BUILD_opencv_video=ON \
	      -D BUILD_opencv_bioinspired=OFF \
	      -D BUILD_opencv_features2d=OFF \
	      -D BUILD_opencv_freetype=OFF \
	      -D BUILD_opencv_fuzzy=OFF \
	      -D BUILD_opencv_hfs=OFF \
	      -D BUILD_opencv_img_hash=OFF \
	      -D BUILD_opencv_intensity_transform=OFF \
	      -D BUILD_opencv_line_descriptor=OFF \
	      -D BUILD_opencv_phase_unwrapping=OFF \
	      -D BUILD_opencv_plot=OFF \
	      -D BUILD_opencv_reg=OFF \
	      -D BUILD_opencv_saliency=OFF \
	      -D BUILD_opencv_signal=OFF \
	      -D BUILD_opencv_tracking=OFF \
	      -D BUILD_opencv_calib3d=OFF \
	      -D BUILD_opencv_stereo=OFF \
	      -D BUILD_opencv_highgui=OFF \
	      -D BUILD_opencv_dnn=OFF \
	      -D BUILD_opencv_flann=OFF \
	      -D BUILD_opencv_ml=OFF \
	      -D BUILD_opencv_objdetect=OFF \
	      -D BUILD_opencv_photo=OFF \
	      -D BUILD_opencv_stitching=OFF \
	      -D BUILD_opencv_superres=OFF \
	      -D BUILD_opencv_videostab=OFF \
	      -D BUILD_opencv_gapi=OFF \
	      -D WITH_QT=OFF \
	      -D WITH_GTK=OFF \
	      -D WITH_OPENGL=OFF \
	      -D CPU_BASELINE=DETECT \
	      ..
	
	make -j2
	sudo make install	
}

# -------------------------------------------------------------
installMediaMTX(){
	echo
	# Check if MediaMTX is already installed
	if [ ! -f "$RTMP_BIN" ]; then
	    echo "MediaMTX not found, installing..."
	
	    # Build download URL (example for v1.9.0)
	    VERSION="v1.15.4"
	    URL="https://github.com/bluenviron/mediamtx/releases/download/${VERSION}/mediamtx_${VERSION}_${OS}_${ARCH}.tar.gz"
	
	    echo "Downloading $URL"
	    mkdir -p "$RTMP_TARGET_DIR"
	    curl -L "$URL" | tar -xz -C "$RTMP_TARGET_DIR"
	
		if [ -x "$RTMP_BIN" ]; then
	    	echo "Successfully installed MediaMTX to $RTMP_TARGET_DIR"
		else
	    	echo "Failed to install MediaMTX to $RTMP_TARGET_DIR"
		fi
	# File exists but not executable
	elif [ ! -x "$RTMP_BIN" ]; then
	    echo "MediaMTX binary exists but is not executable. Fixing permissions..."
	    chmod +x "$RTMP_BIN"
	else
		echo "MediaMTX is already correctly installed to $RTMP_TARGET_DIR"
	fi
}

# -------------------------------------------------------------
installEBServer(){
	echo
	# Making temporary tmp space for pip within larger user directory to avoid running out of disk space during pip installs
	mkdir -p $TARGET_DIR/piptmp
	chmod 700 $TARGET_DIR/piptmp
	
	# Install EBServer package
	URL="https://github.com/lmgardere/$PROJECT_NAME/releases/latest/download/experiencebuffersserver-0.1.0-py3-none-any.whl"
	python3 -m venv --system-site-packages $TARGET_DIR/ebenv
	source $TARGET_DIR/ebenv/bin/activate
	
	if [[ "$ARG1" == "refresh" ]]; then
	    echo "Refreshing EBServer..."
		TMPDIR=$TARGET_DIR/piptmp pip3 install --force-reinstall --no-deps $URL
	else
	    echo "Installing EBServer and requirements..."
		TMPDIR=$TARGET_DIR/piptmp pip3 install $URL
	fi
	
	rm -rf $TARGET_DIR/piptmp
}

# -------------------------------------------------------------
createService() {
	echo
    echo "Creating systemd service..."
    
	sudo ln -sf $TARGET_DIR /root
	sudo ln -sf $TARGET_DIR/ebenv/bin/EBServer /usr/local/bin
	
	# Copy systemd service file
	chmod 644 $TARGET_DIR/$SERVICE_NAME
	sudo ln -sf $TARGET_DIR/$SERVICE_NAME /etc/systemd/system/
	sudo systemctl daemon-reload
	sudo systemctl enable $SERVICE_NAME
	#sudo systemctl start $SERVICE_NAME
	
    echo "Service ${SERVICE_NAME} installed and started."
}

# -------------------------------------------------------------
main() {
    echo "=== ExperienceBuffers Server Installer ==="
    checkRequirements
    installMediaMTX
    installEBServer
    createService
    echo "Installation complete."
    echo "Run \"EBServer\" at the command line to start the program manually. Run using \"sudo\" if necessary."
}

# -------------------------------------------------------------
main
